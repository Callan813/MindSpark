<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Manager with AI Guidance</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Root Variables */
      :root {
        --primary-color: #7cacb3;
        --primary-hover: #518dc3;
        --background-color: #f4f4f4;
        --box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        --border-radius: 8px;
        --bg-color: #f4f4f4;
        --text-color: #333;
        --btn-color: #28a745;
        --btn-hover: #218838;
        --container-bg: white;
        --nav-bg: white;
        --border-color: #ddd;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --logo-color: #4a90e2;
        --primary-color: #4a90e2;
        --secondary-color: #f5f7fa;
        --hover-color: #357abd;
        --tab-bg: #f0f0f0;
        --tab-active: var(--btn-color);
        --tab-text: var(--text-color);
        --tab-active-text: white;
      }

      /* Navigation Styles */
      .navbar {
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem 2rem;
        position: fixed;
        width: 100%;
        top: 0;
        left: 0;
        z-index: 1000;
      }

      .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        text-decoration: none;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
      }

      .nav-links a {
        text-decoration: none;
        color: #333;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        transition: all 0.3s ease;
      }

      .nav-links a:hover {
        background: #f5f7fa;
        color: #4a90e2;
      }

      .icon {
        margin-right: 8px;
        font-size: 1.2em;
      }

      /* Main Content Styles */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 80px 20px 20px; /* Added top padding for navbar */
        line-height: 1.6;
        color: var(--text-color);
        transition: all 0.3s ease;
      }

      .page-container {
        display: flex;
        gap: 20px;
        max-width: 1200px;
        margin: auto;
        flex-wrap: wrap;
      }

      .container {
        background: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
      }

      .task-form-container {
        width: 350px;
        flex-shrink: 0;
      }

      .task-list-container {
        flex-grow: 1;
        min-width: 300px;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 15px;
      }

      input,
      select,
      button {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        box-sizing: border-box;
        transition: all 0.3s ease;
      }

      /* Task Item Styles */
      .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        padding: 15px;
        border-radius: var(--border-radius);
        margin: 10px 0;
        box-shadow: var(--box-shadow);
        transition: transform 0.2s ease;
      }

      .task-item.completed {
        background: #f9f9f9;
        opacity: 0.8;
      }

      .task-item.completed .task-title {
        text-decoration: line-through;
        color: #666;
      }

      .task-item.completed .task-details {
        color: #999;
      }

      .task-item.completed .guidance-btn {
        background: #f0f0f0;
        color: #666;
      }

      .task-item.completed .guidance-content {
        display: none;
      }

      .task-item.completed .loading {
        display: none;
      }

      .task-item.completed .complete-btn {
        background: #f0f0f0;
        color: #666;
      }

      .task-item.completed .delete-btn {
        background: #f0f0f0;
        color: #666;
      }

      .task-item.completed .task-actions {
        display: none;
      }

      /* AI Guidance Styles */
      .guidance-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 16px;
        margin-top: 10px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        width: auto;
      }

      .guidance-content {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid var(--primary-color);
      }

      .guidance-content.active {
        display: block;
      }

      .loading {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: #666;
        padding: 10px;
      }

      .loading.active {
        display: flex;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading .spinner {
        animation: spin 1s linear infinite;
      }

      /* Additional Task Styles */
      .task-content {
        flex: 1;
      }

      .task-title {
        font-weight: bold;
        color: #333;
      }

      .task-details {
        font-size: 0.9em;
        color: #666;
      }

      .delete-btn {
        background: #ff4444;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-left: 10px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .complete-btn {
        background: #00c851;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-left: 10px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .complete-btn:hover {
        background: #00994d;
      }

      .task-actions {
        display: flex;
        gap: 5px;
        align-items: center;
      }

      .filter-container {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        background: #f0f0f0;
        color: #333;
        width: auto;
      }

      .filter-btn.active {
        background: var(--primary-color);
        color: white;
      }

      .summary-guidance-container {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 20px;
      }

      .summary-btn {
        background: var(--primary-color);
        margin-left: auto;
      }

      .priority-section {
        margin: 15px 0;
        padding: 15px;
        border-radius: var(--border-radius);
        border-left: 4px solid;
      }

      .priority-section.high {
        background: #fff5f5;
        border-left-color: #ff4444;
      }

      .priority-section.medium {
        background: #fff9e6;
        border-left-color: #ffbb33;
      }

      .priority-section.low {
        background: #f0fff4;
        border-left-color: #00c851;
      }

      .priority-header {
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .priority-tasks {
        margin-left: 20px;
      }

      .task-recommendation {
        margin-top: 10px;
        font-style: italic;
        color: #666;
      }

      .guidance-section {
        margin: 15px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
      }

      .ai-guidance-section {
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
      }

      .ai-guidance-section h3 {
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .guidance-text {
        line-height: 1.6;
      }

      /* Statistics Styles */
      .statistics-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        margin: 20px 0;
        box-shadow: var(--box-shadow);
      }

      .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .refresh-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: transform 0.3s ease;
      }

      .refresh-btn:hover {
        transform: rotate(180deg);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: var(--secondary-color);
        padding: 15px;
        border-radius: var(--border-radius);
        text-align: center;
      }

      .stat-title {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: var(--primary-color);
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .chart-wrapper {
        background: white;
        padding: 15px;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .charts-container {
          grid-template-columns: 1fr;
        }
      }

      /* Make sure all your elements use these variables */
      button,
      .btn {
        background-color: var(--btn-color);
        color: white;
      }

      button:hover,
      .btn:hover {
        background-color: var(--btn-hover);
      }

      .container,
      .card,
      .popup {
        background: var(--container-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 0 10px var(--shadow-color);
      }

      .task-statistics {
        background-color: var(--stats-color, #000000);
        color: #ffffff;
      }

      /* Update just the Task Statistics header */
      .stats-header h3 {
        color: black !important; /* Force black color for the header */
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-container">
        <a href="landing.html" class="logo">MindSpark</a>
        <div class="nav-links">
          <a href="pomodoro.html"><i class="fas fa-clock icon"></i>Pomodoro</a>
          <a href="calendar.html"
            ><i class="far fa-calendar icon"></i>Calendar</a
          >
          <a href="notes.html"><i class="far fa-sticky-note icon"></i>Notes</a>
          <a href="filemanager.html"><i class="far fa-folder icon"></i>Files</a>
        </div>
      </div>
    </nav>

    <div class="page-container">
      <!-- Task Form Container -->
      <div class="container task-form-container">
        <h2>Task Manager</h2>
        <form id="taskForm">
          <div class="form-group">
            <input
              type="text"
              id="taskTitle"
              placeholder="Task Title"
              required
            />
          </div>
          <div class="form-group">
            <input type="datetime-local" id="taskDeadline" required />
          </div>
          <div class="form-group">
            <select id="taskPriority">
              <option value="High">High Priority</option>
              <option value="Medium">Medium Priority</option>
              <option value="Low">Low Priority</option>
            </select>
          </div>
          <button type="submit">Add Task</button>
        </form>
      </div>

      <!-- Task List Container -->
      <div class="container task-list-container">
        <h2>Tasks</h2>
        <div class="filter-container">
          <button class="filter-btn active" onclick="filterTasks('all')">
            All
          </button>
          <button class="filter-btn" onclick="filterTasks('active')">
            Active
          </button>
          <button class="filter-btn" onclick="filterTasks('completed')">
            Completed
          </button>
          <button
            class="guidance-btn summary-btn"
            onclick="getTasksSummaryGuidance()"
          >
            <i class="fas fa-lightbulb"></i>
            Get Tasks Analysis
          </button>
        </div>
        <div class="statistics-container">
          <div class="stats-header">
            <h3>Task Statistics</h3>
            <button class="refresh-btn" onclick="updateStatistics()">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-title">Total Tasks</div>
              <div class="stat-value" id="totalTasks">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Completed</div>
              <div class="stat-value" id="completedTasks">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Pending</div>
              <div class="stat-value" id="pendingTasks">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-title">Due Today</div>
              <div class="stat-value" id="dueTodayTasks">0</div>
            </div>
          </div>
          <div class="charts-container">
            <div class="chart-wrapper">
              <canvas id="priorityChart"></canvas>
            </div>
            <div class="chart-wrapper">
              <canvas id="progressChart"></canvas>
            </div>
          </div>
        </div>
        <ul id="taskList"></ul>
        <div id="summary-guidance-container" class="summary-guidance-container">
          <div class="loading" id="summary-loading">
            <i class="fas fa-circle-notch spinner"></i>
            Analyzing tasks...
          </div>
          <div class="guidance-content" id="summary-guidance"></div>
        </div>
      </div>
    </div>

    <script>
      // Existing Task Manager Code
      document.addEventListener("DOMContentLoaded", loadTasks);

      const taskForm = document.getElementById("taskForm");
      const taskList = document.getElementById("taskList");

      taskForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const title = document.getElementById("taskTitle").value;
        const deadline = new Date(
          document.getElementById("taskDeadline").value
        );
        const priority = document.getElementById("taskPriority").value;

        const task = { title, deadline: deadline.toISOString(), priority };
        saveTask(task);
        addTaskToList(task);
        setReminder(task);

        taskForm.reset();
      });

      function saveTask(task) {
        let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
        task.completed = false;
        tasks.push(task);
        localStorage.setItem("tasks", JSON.stringify(tasks));
      }

      function loadTasks() {
        let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
        tasks.forEach(addTaskToList);
        tasks.forEach(setReminder);
      }

      function addTaskToList(task) {
        const li = document.createElement("li");
        li.classList.add("task-item");
        if (task.completed) {
          li.classList.add("completed");
        }

        const priorityColor = {
          High: "#ff4444",
          Medium: "#ffbb33",
          Low: "#00C851",
        };

        li.innerHTML = `
          <div class="task-content">
            <div class="task-title">${task.title}</div>
            <div class="task-details">
              <span style="color: ${priorityColor[task.priority]}">
                ${
                  task.priority === "High"
                    ? "☂"
                    : task.priority === "Medium"
                    ? "●"
                    : "▲"
                }
              </span>
              ${task.priority} Priority | Due: ${new Date(
          task.deadline
        ).toLocaleString()}
            </div>
            <button class="guidance-btn" onclick="getGuidance(this, '${
              task.title
            }')">
              <i class="fas fa-lightbulb"></i>
              Get Guidance
            </button>
            <div class="loading" id="loading-${task.title.replace(
              /\s+/g,
              "-"
            )}">
              <i class="fas fa-circle-notch spinner"></i>
              Getting AI suggestions...
            </div>
            <div class="guidance-content" id="guidance-${task.title.replace(
              /\s+/g,
              "-"
            )}"></div>
          </div>
          <div class="task-actions">
            <button class="complete-btn" onclick="toggleTaskComplete('${
              task.title
            }')">
              ${task.completed ? "↺" : "✓"}
            </button>
            <button class="delete-btn" onclick="removeTask('${
              task.title
            }')">✖</button>
          </div>
        `;
        taskList.appendChild(li);
      }

      function removeTask(title) {
        let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
        tasks = tasks.filter((task) => task.title !== title);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        taskList.innerHTML = "";
        loadTasks();
      }

      function setReminder(task) {
        if (task.completed) return;

        const now = new Date().getTime();
        const taskTime = new Date(task.deadline).getTime();
        const reminderTime = taskTime - now - 60000; // Reminder 1 minute before

        if (reminderTime > 0) {
          setTimeout(() => {
            new Notification(`Task Reminder`, {
              body: `${task.title} is due soon!`,
            });
          }, reminderTime);
        }
      }

      function toggleTaskComplete(title) {
        let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
        const taskIndex = tasks.findIndex((task) => task.title === title);

        if (taskIndex !== -1) {
          tasks[taskIndex].completed = !tasks[taskIndex].completed;
          localStorage.setItem("tasks", JSON.stringify(tasks));

          taskList.innerHTML = "";
          tasks.forEach(addTaskToList);
        }
      }

      function filterTasks(filter) {
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Get the statistics container
        const statsContainer = document.querySelector(".statistics-container");

        let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
        taskList.innerHTML = "";

        switch (filter) {
          case "active":
            tasks.filter((task) => !task.completed).forEach(addTaskToList);
            // Hide statistics container
            statsContainer.style.display = "none";
            break;
          case "completed":
            tasks.filter((task) => task.completed).forEach(addTaskToList);
            // Hide statistics container
            statsContainer.style.display = "none";
            break;
          default:
            tasks.forEach(addTaskToList);
            // Show statistics container
            statsContainer.style.display = "block";
            // Update statistics when showing all tasks
            updateStatistics();
            break;
        }
      }

      // AI Guidance Function
      async function getGuidance(button, taskTitle) {
        const taskId = taskTitle.replace(/\s+/g, "-");
        const loadingEl = document.getElementById(`loading-${taskId}`);
        const guidanceEl = document.getElementById(`guidance-${taskId}`);

        button.disabled = true;
        loadingEl.classList.add("active");

        try {
          const response = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyB-azDiiXpTi9t0wR4hZLZ3tjGRsBB8Nuc",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: `As a task management assistant, provide 3-5 clear, actionable steps for completing this task: "${taskTitle}". Keep each step concise and practical.`,
                      },
                    ],
                  },
                ],
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const guidance = processAIResponse(data);

          guidanceEl.innerHTML = `
            <ul class="steps-list">
                ${guidance
                  .map(
                    (step, index) => `
                    <li class="step-item">
                        <span class="step-number">${index + 1}.</span>
                        <span>${step}</span>
                    </li>
                `
                  )
                  .join("")}
            </ul>
          `;

          guidanceEl.classList.add("active");
        } catch (error) {
          console.error("Error:", error);
          guidanceEl.innerHTML = `
            <div style="color: #ff4444; padding: 10px;">
                <i class="fas fa-exclamation-circle"></i>
                Unable to get AI guidance. Please try again later.
            </div>
          `;
          guidanceEl.classList.add("active");
        } finally {
          loadingEl.classList.remove("active");
          button.disabled = false;
        }
      }

      function processAIResponse(data) {
        try {
          if (
            data.candidates &&
            data.candidates[0] &&
            data.candidates[0].content
          ) {
            const response = data.candidates[0].content.parts[0].text;
            // Split by newlines and numbers (1., 2., etc.), filter empty lines
            return response
              .split(/\n|(?=\d\.)/g)
              .map((step) => step.replace(/^\d+\.\s*/, "").trim())
              .filter((step) => step.length > 0);
          }
          return ["No specific guidance available for this task."];
        } catch (error) {
          console.error("Error processing AI response:", error);
          return ["Error processing AI guidance."];
        }
      }

      // Request notification permission on page load
      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      }

      async function getTasksSummaryGuidance() {
        const summaryLoading = document.getElementById("summary-loading");
        const summaryGuidance = document.getElementById("summary-guidance");

        summaryLoading.classList.add("active");
        summaryGuidance.classList.remove("active");

        try {
          const tasks = JSON.parse(localStorage.getItem("tasks")) || [];
          const activeTasks = tasks.filter((task) => !task.completed);

          if (activeTasks.length === 0) {
            summaryGuidance.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>All tasks are completed! Add new tasks to get guidance.</p>
                    </div>
                `;
            summaryGuidance.classList.add("active");
            return;
          }

          // Group tasks by priority
          const tasksByPriority = {
            High: activeTasks.filter((task) => task.priority === "High"),
            Medium: activeTasks.filter((task) => task.priority === "Medium"),
            Low: activeTasks.filter((task) => task.priority === "Low"),
          };

          // Create summary text for AI
          const summaryText = createTasksSummary(tasksByPriority);

          // Using the Gemini API
          const response = await fetch(
            "https://generativelanguage.googleapis.com/v1/models/gemini-pro/generateContent?key=AIzaSyB-azDiiXpTi9t0wR4hZLZ3tjGRsBB8Nuc",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: `As a task management assistant, analyze these tasks and provide strategic guidance:
                                        ${summaryText}
                                        
                                        Format your response in the following sections:
                                        
                                        TASK DISTRIBUTION:
                                        [Analyze how tasks are spread across priority levels]
                                        
                                        EXECUTION ORDER:
                                        [List recommended order of task completion]
                                        
                                        TIME MANAGEMENT:
                                        [Provide time management suggestions]
                                        
                                        PRIORITY RECOMMENDATIONS:
                                        [Give specific advice for each priority level]`,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.7,
                  topK: 40,
                  topP: 0.95,
                  maxOutputTokens: 1000,
                },
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (
            !data.candidates ||
            !data.candidates[0] ||
            !data.candidates[0].content
          ) {
            throw new Error("Invalid response structure from API");
          }

          const guidance = data.candidates[0].content.parts[0].text;

          // Display the summary with task grouping
          summaryGuidance.innerHTML = createSummaryHTML(
            tasksByPriority,
            guidance
          );
          summaryGuidance.classList.add("active");
        } catch (error) {
          console.error("Error details:", error);
          summaryGuidance.innerHTML = `
                <div style="color: #ff4444; padding: 10px;">
                    <i class="fas fa-exclamation-circle"></i>
                    Unable to generate task analysis. Error: ${error.message}
                </div>
            `;
          summaryGuidance.classList.add("active");
        } finally {
          summaryLoading.classList.remove("active");
        }
      }

      function createTasksSummary(tasksByPriority) {
        let summary = "Current tasks by priority:\n\n";

        for (const [priority, tasks] of Object.entries(tasksByPriority)) {
          if (tasks.length > 0) {
            summary += `${priority} Priority Tasks:\n`;
            tasks.forEach((task) => {
              const deadline = new Date(task.deadline).toLocaleString();
              summary += `- ${task.title} (Due: ${deadline})\n`;
            });
            summary += "\n";
          }
        }

        return summary;
      }

      function createSummaryHTML(tasksByPriority, aiGuidance) {
        let html = '<div class="summary-container">';

        // Priority sections
        const priorityColors = {
          High: "#ff4444",
          Medium: "#ffbb33",
          Low: "#00C851",
        };

        // Display tasks by priority
        for (const [priority, tasks] of Object.entries(tasksByPriority)) {
          if (tasks.length > 0) {
            html += `
                    <div class="priority-section ${priority.toLowerCase()}">
                        <div class="priority-header">
                            <i class="fas fa-circle" style="color: ${
                              priorityColors[priority]
                            }"></i>
                            ${priority} Priority Tasks (${tasks.length})
                        </div>
                        <ul class="priority-tasks">
                            ${tasks
                              .map(
                                (task) => `
                                <li>
                                    ${task.title}
                                    <small style="color: #666">
                                        (Due: ${new Date(
                                          task.deadline
                                        ).toLocaleString()})
                                    </small>
                                </li>
                            `
                              )
                              .join("")}
                        </ul>
                    </div>
                `;
          }
        }

        // Format AI Guidance
        const formattedGuidance = aiGuidance
          .split(/\n{2,}/)
          .map((section) => section.trim())
          .filter((section) => section.length > 0)
          .map((section) => `<div class="guidance-section">${section}</div>`)
          .join("");

        // AI Guidance section
        html += `
            <div class="ai-guidance-section">
                <h3><i class="fas fa-robot"></i> AI Analysis & Recommendations</h3>
                <div class="guidance-text">
                    ${formattedGuidance}
                </div>
            </div>
        </div>`;

        return html;
      }

      function updateStatistics() {
        const tasks = JSON.parse(localStorage.getItem("tasks")) || [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Calculate statistics
        const stats = {
          total: tasks.length,
          completed: tasks.filter((task) => task.completed).length,
          pending: tasks.filter((task) => !task.completed).length,
          dueToday: tasks.filter((task) => {
            const taskDate = new Date(task.deadline);
            taskDate.setHours(0, 0, 0, 0);
            return taskDate.getTime() === today.getTime() && !task.completed;
          }).length,
        };

        // Update statistics cards
        document.getElementById("totalTasks").textContent = stats.total;
        document.getElementById("completedTasks").textContent = stats.completed;
        document.getElementById("pendingTasks").textContent = stats.pending;
        document.getElementById("dueTodayTasks").textContent = stats.dueToday;

        // Update charts
        updatePriorityChart(tasks);
        updateProgressChart(tasks);
      }

      function updatePriorityChart(tasks) {
        const activeTasks = tasks.filter((task) => !task.completed);
        const priorityCounts = {
          High: activeTasks.filter((task) => task.priority === "High").length,
          Medium: activeTasks.filter((task) => task.priority === "Medium")
            .length,
          Low: activeTasks.filter((task) => task.priority === "Low").length,
        };

        const ctx = document.getElementById("priorityChart").getContext("2d");

        // Destroy existing chart if it exists
        if (window.priorityChart instanceof Chart) {
          window.priorityChart.destroy();
        }

        window.priorityChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["High", "Medium", "Low"],
            datasets: [
              {
                data: [
                  priorityCounts.High,
                  priorityCounts.Medium,
                  priorityCounts.Low,
                ],
                backgroundColor: ["#ff4444", "#ffbb33", "#00C851"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
              title: {
                display: true,
                text: "Tasks by Priority",
              },
            },
          },
        });
      }

      function updateProgressChart(tasks) {
        // Group tasks by day for the next 7 days
        const next7Days = Array.from({ length: 7 }, (_, i) => {
          const date = new Date();
          date.setDate(date.getDate() + i);
          return date;
        });

        const tasksByDay = next7Days.map((date) => {
          const dayStart = new Date(date);
          dayStart.setHours(0, 0, 0, 0);
          const dayEnd = new Date(date);
          dayEnd.setHours(23, 59, 59, 999);

          return tasks.filter((task) => {
            const taskDate = new Date(task.deadline);
            return (
              taskDate >= dayStart && taskDate <= dayEnd && !task.completed
            );
          }).length;
        });

        const ctx = document.getElementById("progressChart").getContext("2d");

        // Destroy existing chart if it exists
        if (window.progressChart instanceof Chart) {
          window.progressChart.destroy();
        }

        window.progressChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: next7Days.map((date) =>
              date.toLocaleDateString(undefined, { weekday: "short" })
            ),
            datasets: [
              {
                label: "Due Tasks",
                data: tasksByDay,
                backgroundColor: "rgba(124, 172, 179, 0.5)",
                borderColor: "rgb(124, 172, 179)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
              title: {
                display: true,
                text: "Upcoming Tasks (Next 7 Days)",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // Modify your existing task-related functions to update statistics
      const originalSaveTask = saveTask;
      saveTask = function (task) {
        originalSaveTask(task);
        updateStatistics();
      };

      const originalRemoveTask = removeTask;
      removeTask = function (title) {
        originalRemoveTask(title);
        updateStatistics();
      };

      const originalToggleTaskComplete = toggleTaskComplete;
      toggleTaskComplete = function (title) {
        originalToggleTaskComplete(title);
        updateStatistics();
      };

      // Add this to your existing document.addEventListener('DOMContentLoaded', ...)
      document.addEventListener("DOMContentLoaded", function () {
        // ... existing code ...
        updateStatistics();
      });

      function applyTheme(theme) {
        const root = document.documentElement;
        switch (theme) {
          case "dark":
            root.style.setProperty("--bg-color", "#1e1e1e");
            root.style.setProperty("--text-color", "#e0e0e0");
            root.style.setProperty("--btn-color", "#bb86fc");
            root.style.setProperty("--btn-hover", "#9965f4");
            root.style.setProperty("--container-bg", "#2d2d2d");
            root.style.setProperty("--nav-bg", "#2d2d2d");
            root.style.setProperty("--border-color", "#404040");
            root.style.setProperty("--shadow-color", "rgba(0, 0, 0, 0.3)");
            root.style.setProperty("--logo-color", "#bb86fc");
            // Reset background image
            document.body.style.backgroundImage = "none";
            break;

          case "blue":
            root.style.setProperty("--bg-color", "#e3f2fd");
            root.style.setProperty("--text-color", "#1a237e");
            root.style.setProperty("--btn-color", "#1976d2");
            root.style.setProperty("--btn-hover", "#1565c0");
            root.style.setProperty("--container-bg", "white");
            root.style.setProperty("--nav-bg", "#bbdefb");
            root.style.setProperty("--border-color", "#90caf9");
            root.style.setProperty("--shadow-color", "rgba(25, 118, 210, 0.2)");
            root.style.setProperty("--logo-color", "#1976d2");
            // Reset background image
            document.body.style.backgroundImage = "none";
            break;

          case "red":
            root.style.setProperty("--bg-color", "#ffebee");
            root.style.setProperty("--text-color", "#b71c1c");
            root.style.setProperty("--btn-color", "#d32f2f");
            root.style.setProperty("--btn-hover", "#c62828");
            root.style.setProperty("--container-bg", "white");
            root.style.setProperty("--nav-bg", "#ffcdd2");
            root.style.setProperty("--border-color", "#ef9a9a");
            root.style.setProperty("--shadow-color", "rgba(211, 47, 47, 0.2)");
            root.style.setProperty("--logo-color", "#d32f2f");
            // Reset background image
            document.body.style.backgroundImage = "none";
            break;

          case "squidgame":
            root.style.setProperty("--bg-color", "#000000");
            root.style.setProperty("--text-color", "#ffffff");
            root.style.setProperty("--btn-color", "#ff0000");
            root.style.setProperty("--btn-hover", "#cc0000");
            root.style.setProperty("--container-bg", "#1a1a1a");
            root.style.setProperty("--nav-bg", "#000000");
            root.style.setProperty("--border-color", "#ff0000");
            root.style.setProperty("--shadow-color", "rgba(255, 0, 0, 0.3)");
            root.style.setProperty("--logo-color", "#ff0000");
            root.style.setProperty("--primary-color", "#ff0000");
            root.style.setProperty("--secondary-color", "#1a1a1a");
            root.style.setProperty("--hover-color", "#cc0000");
            root.style.setProperty("--tab-bg", "#1a1a1a");
            root.style.setProperty("--tab-active", "#ff0000");
            root.style.setProperty("--tab-text", "#ffffff");
            root.style.setProperty("--tab-active-text", "#ffffff");
            root.style.setProperty("--stats-color", "#000000");

            document.body.style.backgroundImage = "url('squid-game-bg.jpg')";
            document.body.style.backgroundSize = "cover";
            document.body.style.backgroundAttachment = "fixed";
            break;

          default: // light theme
            root.style.setProperty("--bg-color", "#f4f4f4");
            root.style.setProperty("--text-color", "#333");
            root.style.setProperty("--btn-color", "#28a745");
            root.style.setProperty("--btn-hover", "#218838");
            root.style.setProperty("--container-bg", "white");
            root.style.setProperty("--nav-bg", "white");
            root.style.setProperty("--border-color", "#ddd");
            root.style.setProperty("--shadow-color", "rgba(0, 0, 0, 0.1)");
            root.style.setProperty("--logo-color", "#4a90e2");
            // Reset background image
            document.body.style.backgroundImage = "none";
            break;
        }
      }

      // Initialize theme when page loads
      document.addEventListener("DOMContentLoaded", function () {
        const savedTheme = localStorage.getItem("appTheme");
        if (savedTheme) {
          applyTheme(savedTheme);
        }
      });

      // Listen for theme changes in other tabs/windows
      window.addEventListener("storage", function (e) {
        if (e.key === "appTheme") {
          applyTheme(e.newValue);
        }
      });
    </script>
  </body>
</html>
